<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Nostrcoin Block Explorer v0.0.5 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostrcoin Block Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            border-bottom: 2px solid #3a3a3a;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
        }

        .hamburger-btn {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #f5f5f5;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hamburger-btn:hover {
            background: #333;
            border-color: #32CD32;
        }

        .menu-modal .modal-link {
            display: block;
            padding: 12px 16px;
            color: #f5f5f5;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .menu-modal .modal-link:hover {
            background: #333;
            border-color: #32CD32;
            color: #32CD32;
        }

        .menu-modal .modal-link.about-link {
            color: #f28500;
        }

        .menu-modal .modal-link.about-link:hover {
            color: #ff9500;
            border-color: #f28500;
        }

        .logo {
            font-size: 42px;
            font-weight: 700;
            color: #32CD32;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #bbb;
            font-size: 16px;
        }

        .join-nostr-btn {
            background: #f28500;
            color: #1a1a1a;
            border: 1px solid #f28500;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }

        .join-nostr-btn:hover {
            background: #ff9500;
            border-color: #ff9500;
            transform: translateY(-2px);
        }

        .modal .join-nostr-btn {
            color: #1a1a1a !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #32CD32;
            margin-bottom: 4px;
        }

        .stat-subtext {
            font-size: 13px;
            color: #aaa;
        }

        .section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #f28500;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #444;
        }

        .event-item {
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .event-item:hover {
            border-color: #32CD32;
            transform: translateX(4px);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .event-type {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            text-transform: uppercase;
        }

        .event-type.mining {
            background: #d1ecf1;
            color: #0c5460;
        }

        .event-type.transfer {
            background: #d4edda;
            color: #155724;
        }

        .event-time {
            font-size: 13px;
            color: #888;
        }

        .event-details {
            font-size: 14px;
            color: #ccc;
            line-height: 1.6;
        }

        .event-hash {
            font-family: monospace;
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            word-break: break-all;
        }

        .epoch-detail {
            font-size: 11px;
            color: #888;
            font-style: italic;
            margin-top: 2px;
        }

        .pubkey {
            font-family: monospace;
            color: #f28500;
        }

        .amount {
            font-weight: 700;
            color: #32CD32;
        }

        .refresh-btn {
            background: #32CD32;
            color: #1a1a1a;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #28b428;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: #888;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #3a3a3a;
            gap: 8px;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-size: 18px;
            font-weight: 700;
            color: #f28500;
            min-width: 35px;
            flex-shrink: 0;
        }

        .holder-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .holder-pubkey {
            font-family: monospace;
            font-size: 12px;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .holder-balance {
            font-size: 16px;
            font-weight: 700;
            color: #32CD32;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .show-more-btn {
            width: 100%;
            background: #2a2a2a;
            color: #f28500;
            border: 1px solid #f28500;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .show-more-btn:hover {
            background: #f28500;
            color: #1a1a1a;
        }

        .version-footer {
            text-align: center;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #3a3a3a;
        }

        .about-link {
            text-align: center;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 6px;
        }

        .about-link button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            opacity: 0.7;
        }

        .about-link button:hover {
            opacity: 1;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 50;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 16px;
            padding: 26px;
            max-width: 380px;
            width: 100%;
            position: relative;
        }

        .modal h3 {
            margin-bottom: 6px;
            color: #f5f5f5;
        }

        .modal p {
            color: #c0c0c0;
            font-size: 14px;
            line-height: 1.4;
        }

        .modal a {
            color: #f28500;
            text-decoration: none;
        }

        .modal a:hover {
            text-decoration: underline;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 14px;
            background: none;
            border: none;
            color: #999;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #fff;
        }

        .button {
            width: 100%;
            padding: 13px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid transparent;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .button-secondary {
            background: #2a2a2a;
            color: #f28500;
            border: 1px solid #f28500;
        }

        .button-secondary:hover {
            background: #f28500;
            color: #1a1a1a;
        }

        @media (max-width: 600px) {
            .holder-balance {
                font-size: 14px;
            }
            
            .rank {
                font-size: 16px;
                min-width: 30px;
            }
            
            .holder-pubkey {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <button class="hamburger-btn" onclick="toggleMenuModal(true)" aria-label="Menu">‚ò∞</button>
                <button class="join-nostr-btn" onclick="toggleJoinNostrModal(true)">Join Nostr</button>
            </div>
            <div class="logo">‚ö° Nostrcoin Explorer</div>
            <div class="subtitle">Live Nostrcoin Network Statistics & Blockchain Data ‚Ä¢ v0.0.5</div>
        </div>

        <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>

        <div id="indexerStatus" style="font-size:11px;color:#888;margin-bottom:20px;text-align:center;">
            Checking indexers...
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Supply</div>
                <div class="stat-value" id="totalSupply">-</div>
                <div class="stat-subtext">NSTC Mined</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Block Height</div>
                <div class="stat-value" id="blockHeight">-</div>
                <div class="stat-subtext">Latest Block Mined</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    Current Epoch 
                    <span onclick="toggleEpochModal(true)" style="cursor:pointer;font-size:14px;margin-left:4px;" title="What is an epoch?">‚ÑπÔ∏è</span>
                </div>
                <div class="stat-value" id="currentEpoch">-</div>
                <div class="stat-subtext">10-Minute Intervals</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Events</div>
                <div class="stat-value" id="totalEvents">-</div>
                <div class="stat-subtext">Blocks + Transfers</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">‚õèÔ∏è Recent Blocks</div>
            <div id="recentBlocks">
                <div class="loading">Loading recent blocks...</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üí∏ Recent Transfers</div>
            <div id="recentTransfers">
                <div class="loading">Loading transfers...</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üìä Top Holders</div>
            <div id="leaderboard">
                <div class="loading">Loading leaderboard...</div>
            </div>
        </div>

        <div class="version-footer">
            Nostrcoin Block Explorer v0.0.5
        </div>

        <div class="about-link">
            <button type="button" onclick="toggleAboutModal(true)">About</button>
        </div>
    </div>

    <div id="menuModal" class="modal-overlay" aria-hidden="true">
        <div class="modal menu-modal">
            <button class="modal-close" onclick="toggleMenuModal(false)" aria-label="Close">√ó</button>
            <h3>Menu</h3>
            <a href="#" onclick="toggleMenuModal(false); toggleAboutModal(true); return false;" class="modal-link about-link">About</a>
            <a href="https://saccoci.github.io/explorer.html" target="_blank" class="modal-link">Explorer</a>
            <a href="https://saccoci.github.io/wallet.html" target="_blank" class="modal-link">Wallet</a>
            <a href="https://nostrcoin.boards.net" target="_blank" class="modal-link">Forum</a>
            <a href="https://github.com/saccoci" target="_blank" class="modal-link">GitHub Repo</a>
            <button class="button button-secondary" style="margin-top:8px;" onclick="toggleMenuModal(false)">Close</button>
        </div>
    </div>

    <div id="joinNostrModal" class="modal-overlay" aria-hidden="true">
        <div class="modal">
            <button class="modal-close" onclick="toggleJoinNostrModal(false)" aria-label="Close">√ó</button>
            <h3>What is Nostr?</h3>
            <p style="margin-top:12px;">
                <strong>Nostr</strong> (Notes and Other Stuff Transmitted by Relays) is a decentralized social protocol that enables global, decentralized, and censorship-resistant social networking.
            </p>
            <p style="margin-top:12px;">
                <strong>Why do I need Nostr for Nostrcoin?</strong> Nostrcoin is built on top of Nostr's event system. Since Nostrcoin uses Nostr events for its blockchain (mining events and transfer events), you need a Nostr account to use the wallet and interact with the network.
            </p>
            <p style="margin-top:12px;">
                To get started with Nostrcoin, you'll need to:
            </p>
            <ul style="margin-top:8px;margin-left:20px;line-height:1.8;">
                <li>Create a Nostr account</li>
                <li>Install a Nostr signing extension to your web browser (like AKA Profiles, Gooti, nos2x, nos2x-fox, Alby, or others)</li>
            </ul>
            <a href="https://nstart.me" target="_blank" class="join-nostr-btn" style="margin-top:16px;text-align:center;display:block;">Join Nostr</a>
            <button class="button button-secondary" style="margin-top:16px;" onclick="toggleJoinNostrModal(false)">Close</button>
        </div>
    </div>

    <div id="aboutModal" class="modal-overlay" aria-hidden="true">
        <div class="modal">
            <button class="modal-close" onclick="toggleAboutModal(false)" aria-label="Close">√ó</button>
            <h3>About Nostrcoin Block Explorer</h3>
            <p style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-top:4px;">Version 0.0.5</p>
            <p style="margin-top:12px;">
                The Nostrcoin Block Explorer provides real-time network statistics, transaction history, and blockchain data for the Nostrcoin (NSTC) network. View recent blocks, transfers, top holders, and network metrics.
            </p>
            <p style="margin-top:10px;font-size:12px;color:#ff6b6b;">
                <strong>Disclaimer:</strong> This is for education and fun only. Expect bugs, potential loss of coins, and no monetary value. Do not invest real money.
            </p>
            <button class="button button-secondary" style="margin-top:16px;" onclick="toggleAboutModal(false)">Close</button>
        </div>
    </div>

    <div id="epochModal" class="modal-overlay" aria-hidden="true">
        <div class="modal">
            <button class="modal-close" onclick="toggleEpochModal(false)" aria-label="Close">√ó</button>
            <h3>What is an Epoch?</h3>
            <p style="margin-top:12px;">
                In Nostrcoin, an <strong>epoch</strong> is a 10-minute time window during which miners can attempt to mine a block. Each epoch starts exactly 10 minutes after the previous one.
            </p>
            <p style="margin-top:12px;">
                <strong>Key Points:</strong>
            </p>
            <ul style="margin-top:8px;margin-left:20px;line-height:1.8;">
                <li>One epoch = 10 minutes</li>
                <li>Only one valid block per epoch</li>
                <li>Miners compete during each epoch</li>
                <li>First valid proof-of-work wins</li>
            </ul>
            <p style="margin-top:12px;">
                <strong>Note:</strong> This is different from Bitcoin's "epoch" (halving schedule). In Nostrcoin, epochs are simply time intervals for mining blocks, not reward halvings.
            </p>
            <button class="button button-secondary" style="margin-top:16px;" onclick="toggleEpochModal(false)">Got it!</button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - SAFE TO EDIT
        // ============================================
        const INDEXER_CONFIG = {
            indexers: [
				'http://localhost:3000',  // Your local indexer    
				'https://vm-182.lnvps.cloud',  // VPS indexer
                // Add more indexers below (one per line):
                // 'https://another-indexer.com',
                // 'https://third-indexer.org',
            ]
        };
        // ============================================
        // DO NOT EDIT BELOW THIS LINE
        // ============================================

        let allBalances = {};
        let allEvents = [];
        let showAllHolders = false;
        let indexerStatus = {}; // Track which indexers are responding

        // Bech32 encoding for npub conversion
        const CHARSET = "qpzry9x8gf2tvdw0s3jn54khce6mua7l";

        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }

        function convertBits(data, fromBits, toBits, pad = true) {
            let acc = 0;
            let bits = 0;
            const result = [];
            const maxv = (1 << toBits) - 1;
            const max_acc = (1 << (fromBits + toBits - 1)) - 1;
            for (let value of data) {
                if (value < 0 || (value >> fromBits)) return null;
                acc = ((acc << fromBits) | value) & max_acc;
                bits += fromBits;
                while (bits >= toBits) {
                    bits -= toBits;
                    result.push((acc >> bits) & maxv);
                }
            }
            if (pad) {
                if (bits) result.push((acc << (toBits - bits)) & maxv);
            } else if (bits >= fromBits || ((acc << (toBits - bits)) & maxv)) {
                return null;
            }
            return result;
        }

        function bech32Encode(hrp, data) {
            const checksum = createChecksum(hrp, data);
            const values = data.concat(checksum);
            return hrp + '1' + values.map(v => CHARSET[v]).join('');
        }

        function createChecksum(hrp, data) {
            const values = hrpExpand(hrp).concat(data);
            const polymodResult = polymod(values.concat([0, 0, 0, 0, 0, 0])) ^ 1;
            const checksum = [];
            for (let p = 0; p < 6; ++p) {
                checksum.push((polymodResult >> 5 * (5 - p)) & 31);
            }
            return checksum;
        }

        function polymod(values) {
            const GENERATORS = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
            let chk = 1;
            for (let p = 0; p < values.length; ++p) {
                const top = chk >> 25;
                chk = (chk & 0x1ffffff) << 5 ^ values[p];
                for (let i = 0; i < 5; i++) {
                    if ((top >> i) & 1) {
                        chk ^= GENERATORS[i];
                    }
                }
            }
            return chk;
        }

        function hrpExpand(hrp) {
            const ret = [];
            for (let i = 0; i < hrp.length; i++) ret.push(hrp.charCodeAt(i) >> 5);
            ret.push(0);
            for (let i = 0; i < hrp.length; i++) ret.push(hrp.charCodeAt(i) & 31);
            return ret;
        }

        function pubkeyToNpub(hexPubkey) {
            try {
                const bytes = hexToBytes(hexPubkey);
                const converted = convertBits(bytes, 8, 5);
                if (!converted) return hexPubkey;
                return bech32Encode('npub', converted);
            } catch (e) {
                console.error('Failed to convert to npub:', e);
                return hexPubkey;
            }
        }

        async function fetchStats() {
            try {
                // Query all indexers in parallel
                const promises = INDEXER_CONFIG.indexers.map(async (indexerUrl) => {
                    try {
                        const response = await fetch(`${indexerUrl}/stats`, { timeout: 5000 });
                        const data = await response.json();
                        indexerStatus[indexerUrl] = 'online';
                        return { indexerUrl, data, error: null };
                    } catch (error) {
                        indexerStatus[indexerUrl] = 'offline';
                        return { indexerUrl, data: null, error: error.message };
                    }
                });

                const results = await Promise.all(promises);
                const validResults = results.filter(r => r.data !== null);

                if (validResults.length === 0) {
                    console.error('All indexers failed to respond');
                    return;
                }

                // Use the first valid result (or implement consensus logic)
                const data = validResults[0].data;
                
                document.getElementById('totalSupply').textContent = data.totalSupply.toLocaleString();
                document.getElementById('totalEvents').textContent = data.totalEvents;
                document.getElementById('currentEpoch').textContent = data.currentEpoch.toLocaleString();
                
                // Update block height display (calculated from events)
                const totalBlocks = allEvents.filter(e => e.kind === 30333).length;
                const blockHeight = totalBlocks > 0 ? totalBlocks - 1 : 0;
                document.getElementById('blockHeight').textContent = blockHeight;

                // Check for disagreements
                if (validResults.length > 1) {
                    const supplies = validResults.map(r => r.data.totalSupply);
                    const allAgree = supplies.every(s => s === supplies[0]);
                    if (!allAgree) {
                        console.warn('Indexers disagree on total supply:', validResults);
                    }
                }
            } catch (error) {
                console.error('Failed to fetch stats:', error);
            }
        }

        async function fetchEvents() {
            try {
                // Query all indexers in parallel
                const promises = INDEXER_CONFIG.indexers.map(async (indexerUrl) => {
                    try {
                        const response = await fetch(`${indexerUrl}/events`, { timeout: 5000 });
                        const data = await response.json();
                        return { indexerUrl, events: data.events || [], error: null };
                    } catch (error) {
                        return { indexerUrl, events: [], error: error.message };
                    }
                });

                const results = await Promise.all(promises);
                const validResults = results.filter(r => r.events.length > 0);

                if (validResults.length === 0) {
                    console.error('All indexers failed to return events');
                    return;
                }

                // Use the result with the most events (or implement merge logic)
                const mostEvents = validResults.reduce((max, r) => 
                    r.events.length > max.events.length ? r : max
                );
                
                allEvents = mostEvents.events;
                
                displayRecentBlocks();
                displayRecentTransfers();

                // Check for disagreements
                if (validResults.length > 1) {
                    const eventCounts = validResults.map(r => r.events.length);
                    const allAgree = eventCounts.every(c => c === eventCounts[0]);
                    if (!allAgree) {
                        console.warn('Indexers have different event counts:', validResults.map(r => ({
                            indexer: r.indexerUrl,
                            count: r.events.length
                        })));
                    }
                }
            } catch (error) {
                console.error('Failed to fetch events:', error);
            }
        }

        async function fetchLeaderboard() {
            try {
                const pubkeys = new Set();
                allEvents.forEach(event => {
                    pubkeys.add(event.pubkey);
                });

                const balancePromises = Array.from(pubkeys).map(async pubkey => {
                    // Query all indexers for this pubkey
                    const indexerPromises = INDEXER_CONFIG.indexers.map(async (indexerUrl) => {
                        try {
                            const response = await fetch(`${indexerUrl}/balance/${pubkey}`, { timeout: 5000 });
                            const data = await response.json();
                            return { indexerUrl, balance: data.balance, error: null };
                        } catch (error) {
                            return { indexerUrl, balance: 0, error: error.message };
                        }
                    });

                    const indexerResults = await Promise.all(indexerPromises);
                    const validResults = indexerResults.filter(r => r.error === null);

                    if (validResults.length === 0) {
                        return { pubkey, balance: 0 };
                    }

                    // Use majority consensus or average
                    const balances = validResults.map(r => r.balance);
                    const allAgree = balances.every(b => b === balances[0]);
                    
                    if (!allAgree) {
                        console.warn(`Indexers disagree on balance for ${pubkey}:`, validResults);
                    }

                    // Use the most common balance (majority)
                    const balance = balances[0];
                    return { pubkey, balance };
                });

                const balances = await Promise.all(balancePromises);
                allBalances = balances.reduce((acc, item) => {
                    acc[item.pubkey] = item.balance;
                    return acc;
                }, {});

                displayLeaderboard(balances);
            } catch (error) {
                console.error('Failed to fetch leaderboard:', error);
            }
        }

        function displayLeaderboard(balances) {
            const sorted = balances.filter(b => b.balance > 0).sort((a, b) => b.balance - a.balance);
            const container = document.getElementById('leaderboard');
            
            if (sorted.length === 0) {
                container.innerHTML = '<div class="no-data">No holders yet</div>';
                return;
            }

            const displayCount = showAllHolders ? Math.min(sorted.length, 25) : Math.min(sorted.length, 3);
            const hasMore = sorted.length > 3;

            container.innerHTML = sorted.slice(0, displayCount).map((item, index) => {
                const npub = pubkeyToNpub(item.pubkey);
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                return `
                <div class="leaderboard-item">
                    <div class="rank">${medal || '#' + (index + 1)}</div>
                    <div class="holder-info">
                        <div class="holder-pubkey">${npub}</div>
                    </div>
                    <div class="holder-balance">${item.balance.toFixed(8)} NSTC</div>
                </div>
            `}).join('');

            if (hasMore) {
                const buttonText = showAllHolders ? 'Show Less' : `Show All Holders (${sorted.length})`;
                container.innerHTML += `
                    <button class="show-more-btn" onclick="toggleHolders()">
                        ${buttonText}
                    </button>
                `;
            }
        }

        function toggleHolders() {
            showAllHolders = !showAllHolders;
            const balances = Object.keys(allBalances).map(pubkey => ({
                pubkey,
                balance: allBalances[pubkey]
            }));
            displayLeaderboard(balances);
        }

        function displayRecentBlocks() {
            const allBlocks = allEvents.filter(e => e.kind === 30333);
            const blocks = allBlocks.slice(-10).reverse();
            const container = document.getElementById('recentBlocks');
            
            if (blocks.length === 0) {
                container.innerHTML = '<div class="no-data">No blocks mined yet</div>';
                return;
            }

            // Calculate block numbers: total blocks mined minus position from end
            const totalBlocks = allBlocks.length;

            container.innerHTML = blocks.map((block, index) => {
                const date = new Date(block.created_at * 1000).toLocaleString();
                const npub = pubkeyToNpub(block.pubkey);
                const epochNumber = block.epoch !== undefined ? block.epoch : 'N/A';
                const blockNumber = totalBlocks - index - 1; // Sequential block number starting from 0
                
                return `
                    <div class="event-item">
                        <div class="event-header">
                            <span class="event-type mining">‚õèÔ∏è Block ${blockNumber}</span>
                            <span class="event-time">${date}</span>
                        </div>
                        <div class="event-details">
                            Miner: <span class="pubkey">${npub.substring(0, 20)}...</span><br>
                            Reward: <span class="amount">50 NSTC</span>
                            <div class="epoch-detail">Mined at epoch ${epochNumber}</div>
                        </div>
                        <div class="event-hash">Block ID: ${block.id}</div>
                    </div>
                `;
            }).join('');
        }

        function displayRecentTransfers() {
            const transfers = allEvents.filter(e => e.kind === 30334).slice(-10).reverse();
            const container = document.getElementById('recentTransfers');
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="no-data">No transfers yet</div>';
                return;
            }

            container.innerHTML = transfers.map(tx => {
                const date = new Date(tx.created_at * 1000).toLocaleString();
                const senderNpub = pubkeyToNpub(tx.pubkey);
                
                // Parse recipient and amount from tags (since indexer doesn't expand them)
                let recipientHex = null;
                let amount = null;
                
                if (tx.tags && Array.isArray(tx.tags)) {
                    const recipientTag = tx.tags.find(t => Array.isArray(t) && t[0] === 'p');
                    const amountTag = tx.tags.find(t => Array.isArray(t) && t[0] === 'amount');
                    
                    if (recipientTag && recipientTag[1]) {
                        recipientHex = recipientTag[1];
                    }
                    if (amountTag && amountTag[1]) {
                        amount = parseFloat(amountTag[1]);
                    }
                }
                
                let recipientNpub = 'Unknown';
                if (recipientHex && recipientHex.length === 64) {
                    try {
                        recipientNpub = pubkeyToNpub(recipientHex);
                    } catch (e) {
                        recipientNpub = recipientHex.substring(0, 16) + '...';
                    }
                }
                
                const displayAmount = amount && !isNaN(amount) ? amount.toFixed(8) : '0.00000000';
                
                return `
                    <div class="event-item">
                        <div class="event-header">
                            <span class="event-type transfer">üí∏ Transfer</span>
                            <span class="event-time">${date}</span>
                        </div>
                        <div class="event-details">
                            From: <span class="pubkey">${senderNpub.substring(0, 20)}...</span><br>
                            To: <span class="pubkey">${recipientNpub.substring(0, 20)}...</span><br>
                            Amount: <span class="amount">${displayAmount} NSTC</span>
                        </div>
                        <div class="event-hash">TX ID: ${tx.id}</div>
                    </div>
                `;
            }).join('');
        }

        async function refreshData() {
            // Fetch events FIRST so we have the data for block height calculation
            await fetchEvents();
            await fetchStats();
            await fetchLeaderboard();
            updateIndexerStatusDisplay();
        }

        function toggleMenuModal(show) {
            const modal = document.getElementById('menuModal');
            if (show) {
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
            } else {
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
            }
        }

        function toggleJoinNostrModal(show) {
            const modal = document.getElementById('joinNostrModal');
            if (show) {
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
            } else {
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
            }
        }

        function toggleAboutModal(show) {
            const modal = document.getElementById('aboutModal');
            if (show) {
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
            } else {
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
            }
        }

        function toggleEpochModal(show) {
            const modal = document.getElementById('epochModal');
            if (show) {
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
            } else {
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
            }
        }

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                toggleMenuModal(false);
                toggleJoinNostrModal(false);
                toggleAboutModal(false);
                toggleEpochModal(false);
            }
        });

        window.addEventListener('click', (event) => {
            if (event.target === document.getElementById('menuModal')) toggleMenuModal(false);
            if (event.target === document.getElementById('joinNostrModal')) toggleJoinNostrModal(false);
            if (event.target === document.getElementById('aboutModal')) toggleAboutModal(false);
            if (event.target === document.getElementById('epochModal')) toggleEpochModal(false);
        });

        function updateIndexerStatusDisplay() {
            const statusDiv = document.getElementById('indexerStatus');
            const statuses = Object.entries(indexerStatus).map(([url, status]) => {
                const icon = status === 'online' ? '‚úì' : '‚úó';
                const color = status === 'online' ? '#32CD32' : '#ff6b6b';
                const shortUrl = url.replace('https://', '').replace('http://', '').split('/')[0];
                return `<span style="color:${color}">${icon} ${shortUrl}</span>`;
            });
            
            if (statuses.length > 0) {
                statusDiv.innerHTML = `Indexers: ${statuses.join(' ‚Ä¢ ')}`;
            } else {
                statusDiv.innerHTML = 'No indexers configured';
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
        });
    </script>
</body>
</html>
