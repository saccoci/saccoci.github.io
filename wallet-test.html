<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Nostrcoin Wallet v0.0.9 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostrcoin (NSTC) Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.3/qrcode.min.js"></script>
    <!-- Add noble curves for secp256k1 schnorr pubkey derivation -->
    <script type="module">
        import { secp256k1 } from 'https://cdn.jsdelivr.net/npm/@noble/curves@1.4.0/secp256k1.js';
        window.secp256k1 = secp256k1;
    </script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a1a;color:#f5f5f5;min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        .header{text-align:center;margin-bottom:40px;padding:30px 0;border-bottom:2px solid #3a3a3a}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:20px}
        .hamburger-btn{background:#2a2a2a;border:1px solid #444;color:#f5f5f5;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:20px;line-height:1;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .hamburger-btn:hover{background:#333;border-color:#32CD32}
        .logo{font-size:42px;font-weight:700;color:#32CD32;margin-bottom:8px}
        .subtitle{color:#bbb;font-size:16px}
        .section{background:#2a2a2a;border:1px solid #444;border-radius:12px;padding:24px;margin-bottom:30px}
        .section-title{font-size:20px;font-weight:600;color:#f28500;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #444}
        .balance-amount{font-size:42px;font-weight:700;color:#32CD32;margin:12px 0}
        .npub-display{font-size:11px;color:#888;font-family:monospace;word-break:break-all;margin-top:8px}
        .button{width:100%;padding:13px;border-radius:8px;font-size:14px;font-weight:600;border:1px solid transparent;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;transition:all .2s;margin-bottom:12px}
        .button-primary{background:#32CD32;color:#1a1a1a;border-color:#32CD32}
        .button-primary:hover{background:#28b428;border-color:#28b428;transform:translateY(-2px)}
        .button-secondary{background:#2a2a2a;color:#f28500;border:1px solid #f28500}
        .button-secondary:hover{background:#f28500;color:#1a1a1a}
        .status{padding:12px;border-radius:8px;border:1px solid #444;background:#2a2a2a;font-size:14px;margin-bottom:20px}
        .status.success{color:#32CD32;border-color:#32CD32}
        .status.error{color:#ff6b6b;border-color:#ff6b6b}
        .status.info{color:#66c2ff;border-color:#66c2ff}
        .join-nostr-btn{background:#f28500;color:#1a1a1a;border:1px solid #f28500;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;text-decoration:none;display:inline-block;transition:all .2s}
        .join-nostr-btn:hover{background:#ff9500;border-color:#ff9500;transform:translateY(-2px)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;padding:20px;z-index:50}
        .modal-overlay.active{display:flex}
        .modal{background:#2a2a2a;border:1px solid #444;border-radius:16px;padding:26px;max-width:500px;width:100%;position:relative}
        .modal h3{margin-bottom:16px;color:#f5f5f5}
        .modal p{color:#c0c0c0;font-size:14px;line-height:1.4;margin-bottom:12px}
        .modal-close{position:absolute;top:10px;right:14px;background:none;border:none;color:#999;font-size:20px;cursor:pointer}
        .modal-close:hover{color:#fff}
        .qr-box{background:#1a1a1a;border-radius:8px;padding:20px;text-align:center;margin:20px 0}
        .connect-url{background:#1a1a1a;padding:12px;border-radius:6px;font-family:monospace;font-size:11px;word-break:break-all;margin-top:12px;color:#888}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div style="flex:1"></div>
                <button class="join-nostr-btn" onclick="window.open('https://nstart.me', '_blank')">Join Nostr</button>
            </div>
            <div class="logo">⚡ Nostrcoin Wallet</div>
            <div class="subtitle">NSTC Wallet • Nostr-native PoW</div>
        </div>

        <div id="status"></div>

        <div id="notConnected">
            <div class="section">
                <div class="section-title">Connect Wallet</div>
                <p style="text-align:center;color:#aaa;margin-bottom:20px;">Connect your Nostr wallet to get started</p>
                
                <button class="button button-primary" onclick="connectExtension()">Connect Browser Extension</button>
                <button class="button button-primary" onclick="showNsecAppModal()" style="margin-top:12px;">Connect Mobile (nsec.app)</button>
                
                <p style="text-align:center;color:#888;font-size:13px;margin-top:20px;">
                    Don't have a Nostr account? 
                    <a href="https://nstart.me" target="_blank" style="color:#f28500;text-decoration:none;">Learn more</a>
                </p>
            </div>
        </div>

        <div id="connected" style="display:none;">
            <div class="section">
                <div style="text-align:center;">
                    <div style="font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Balance</div>
                    <div class="balance-amount" id="balanceAmount">0.00000000</div>
                    <div style="font-size:13px;color:#aaa;margin-bottom:12px;" id="balanceSubtext">Connected</div>
                    <div class="npub-display" id="npubDisplay">npub...</div>
                </div>
            </div>
            
            <button class="button button-secondary" onclick="disconnectWallet()">Disconnect</button>
        </div>
    </div>

    <!-- nsec.app Connection Modal -->
    <div id="nsecAppModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeNsecAppModal()">×</button>
            <h3>Connect with nsec.app</h3>
            <p>Scan this QR code with nsec.app on your mobile device, or click the button below:</p>
            
            <div class="qr-box">
                <div id="nsecAppQR"></div>
            </div>
            
            <a id="nsecAppLink" href="#" class="button button-primary" target="_blank" style="text-decoration:none;text-align:center;display:block;">
                Open in nsec.app
            </a>
            
            <div class="connect-url" id="connectUrl" style="cursor:pointer;" onclick="copyConnectUrl()" title="Click to copy">
                Generating connection...
            </div>
            
            <button class="button button-secondary" style="margin-top:16px;" onclick="closeNsecAppModal()">Cancel</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            protocolTag: 'nostrcoin',
            relays: [
                'wss://relay.damus.io',
                'wss://nos.lol',
                'wss://relay.nostr.band',
                'wss://nostr.mom'
            ]
        };

        const state = {
            pubkeyHex: null,
            npub: null,
            balance: 0,
            connected: false,
            nsecAppConnection: null
        };

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        // Bech32 encoding functions (unchanged)
        const CHARSET = "qpzry9x8gf2tvdw0s3jn54khce6mua7l";

        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }

        function convertBits(data, fromBits, toBits, pad = true) {
            let acc = 0, bits = 0;
            const result = [];
            const maxv = (1 << toBits) - 1;
            const max_acc = (1 << (fromBits + toBits - 1)) - 1;
            for (let value of data) {
                if (value < 0 || (value >> fromBits)) return null;
                acc = ((acc << fromBits) | value) & max_acc;
                bits += fromBits;
                while (bits >= toBits) {
                    bits -= toBits;
                    result.push((acc >> bits) & maxv);
                }
            }
            if (pad && bits) result.push((acc << (toBits - bits)) & maxv);
            return result;
        }

        function bech32Encode(hrp, data) {
            const checksum = createChecksum(hrp, data);
            const values = data.concat(checksum);
            return hrp + '1' + values.map(v => CHARSET[v]).join('');
        }

        function createChecksum(hrp, data) {
            const values = hrpExpand(hrp).concat(data);
            const polymodResult = polymod(values.concat([0, 0, 0, 0, 0, 0])) ^ 1;
            const checksum = [];
            for (let p = 0; p < 6; ++p) {
                checksum.push((polymodResult >> 5 * (5 - p)) & 31);
            }
            return checksum;
        }

        function polymod(values) {
            const GENERATORS = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
            let chk = 1;
            for (let p = 0; p < values.length; ++p) {
                const top = chk >> 25;
                chk = (chk & 0x1ffffff) << 5 ^ values[p];
                for (let i = 0; i < 5; i++) {
                    if ((top >> i) & 1) chk ^= GENERATORS[i];
                }
            }
            return chk;
        }

        function hrpExpand(hrp) {
            const ret = [];
            for (let i = 0; i < hrp.length; i++) ret.push(hrp.charCodeAt(i) >> 5);
            ret.push(0);
            for (let i = 0; i < hrp.length; i++) ret.push(hrp.charCodeAt(i) & 31);
            return ret;
        }

        function pubkeyToNpub(hexPubkey) {
            const bytes = hexToBytes(hexPubkey);
            const converted = convertBits(bytes, 8, 5);
            if (!converted) throw new Error('Failed to encode npub');
            return bech32Encode('npub', converted);
        }

        // Extension connection (unchanged)
        async function connectExtension() {
            if (!window.nostr) {
                showStatus('No browser extension found. Please install nos2x, Alby, or similar.', 'error');
                return;
            }

            try {
                showStatus('Connecting to extension...', 'info');
                const pubkey = await window.nostr.getPublicKey();
                handleConnection(pubkey, 'Browser Extension');
            } catch (error) {
                showStatus('Extension connection failed: ' + error.message, 'error');
            }
        }

        // nsec.app connection - NEW CORRECT FORMAT
        async function showNsecAppModal() {
            document.getElementById('nsecAppModal').classList.add('active');
            
            // Wait for secp256k1 to load
            if (!window.secp256k1) {
                showStatus('Loading cryptography library...', 'info');
                await new Promise(resolve => {
                    const check = () => window.secp256k1 ? resolve() : setTimeout(check, 100);
                    check();
                });
            }

            setTimeout(() => {
                const connectUrl = generateNsecAppUrl();
                document.getElementById('connectUrl').textContent = connectUrl;
                document.getElementById('nsecAppLink').href = connectUrl;
                
                try {
                    const qrContainer = document.getElementById('nsecAppQR');
                    qrContainer.innerHTML = '';
                    
                    if (typeof QRCode !== 'undefined') {
                        new QRCode(qrContainer, {
                            text: connectUrl,
                            width: 256,
                            height: 256,
                            colorDark: "#f5f5f5",
                            colorLight: "#1a1a1a"
                        });
                        showStatus('Scan QR code with nsec.app', 'info');
                    } else {
                        qrContainer.innerHTML = '<p style="color:#ff6b6b;">QRCode library not loaded</p>';
                    }
                } catch (e) {
                    console.error('QR generation failed:', e);
                    document.getElementById('nsecAppQR').innerHTML = '<p style="color:#ff6b6b;">QR generation failed</p>';
                }
            }, 100);
        }

        function generateNsecAppUrl() {
            // Generate temporary client secret key
            const secretBytes = crypto.getRandomValues(new Uint8Array(32));
            
            // Derive public key (hex) using schnorr
            const pubkeyHex = window.secp256k1.schnorr.getPublicKey(secretBytes);
            
            // Build query params
            const params = new URLSearchParams();
            CONFIG.relays.forEach(relay => params.append('relay', encodeURIComponent(relay)));
            
            // Metadata as JSON (standard per NIP-46)
            const metadata = {
                name: 'Nostrcoin Wallet',
                url: window.location.origin,
                description: 'Nostr-native PoW wallet'
            };
            params.append('metadata', JSON.stringify(metadata));
            
            // Optional: some signers prefer flat params for smaller QR
            // params.append('name', 'Nostrcoin Wallet');
            
            return `nostrconnect://${pubkeyHex}?${params.toString()}`;
        }

        function closeNsecAppModal() {
            document.getElementById('nsecAppModal').classList.remove('active');
        }

        function copyConnectUrl() {
            const url = document.getElementById('connectUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                showStatus('✓ Connection URL copied', 'success');
            }).catch(() => {
                showStatus('Failed to copy', 'error');
            });
        }

        function handleConnection(pubkeyHex, source) {
            state.pubkeyHex = pubkeyHex;
            state.npub = pubkeyToNpub(pubkeyHex);
            state.connected = true;

            document.getElementById('npubDisplay').textContent = state.npub;
            document.getElementById('balanceSubtext').textContent = `Connected via ${source}`;
            document.getElementById('notConnected').style.display = 'none';
            document.getElementById('connected').style.display = 'block';

            closeNsecAppModal();
            showStatus(`✓ Connected successfully`, 'success');
            
            // TODO: Fetch balance from indexer
        }

        function disconnectWallet() {
            state.pubkeyHex = null;
            state.npub = null;
            state.connected = false;

            document.getElementById('connected').style.display = 'none';
            document.getElementById('notConnected').style.display = 'block';
            showStatus('Wallet disconnected', 'info');
        }

        // Close modal on escape key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeNsecAppModal();
        });
        
        // Close modal on background click
        document.getElementById('nsecAppModal').addEventListener('click', (e) => {
            if (e.target.id === 'nsecAppModal') closeNsecAppModal();
        });
    </script>
</body>
</html>