<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Nostrcoin Wallet v0.1.0 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostrcoin (NSTC) Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.3/qrcode.min.js"></script>
    <!-- Nostr / secp256k1 helper -->
    <script src="https://unpkg.com/nostr-tools@2.7.0/lib/nostr.bundle.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a1a;color:#f5f5f5;min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        .header{text-align:center;margin-bottom:40px;padding:30px 0;border-bottom:2px solid #3a3a3a}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:20px}
        .hamburger-btn{background:#2a2a2a;border:1px solid #444;color:#f5f5f5;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:20px;line-height:1;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .hamburger-btn:hover{background:#333;border-color:#32CD32}
        .logo{font-size:42px;font-weight:700;color:#32CD32;margin-bottom:8px}
        .subtitle{color:#bbb;font-size:16px}
        .section{background:#2a2a2a;border:1px solid #444;border-radius:12px;padding:24px;margin-bottom:30px}
        .section-title{font-size:20px;font-weight:600;color:#f28500;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #444}
        .balance-amount{font-size:42px;font-weight:700;color:#32CD32;margin:12px 0}
        .npub-display{font-size:11px;color:#888;font-family:monospace;word-break:break-all;margin-top:8px}
        .button{width:100%;padding:13px;border-radius:8px;font-size:14px;font-weight:600;border:1px solid transparent;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;transition:all .2s;margin-bottom:12px}
        .button-primary{background:#32CD32;color:#1a1a1a;border-color:#32CD32}
        .button-primary:hover{background:#28b428;border-color:#28b428;transform:translateY(-2px)}
        .button-secondary{background:#2a2a2a;color:#f28500;border:1px solid #f28500}
        .button-secondary:hover{background:#f28500;color:#1a1a1a}
        .refresh-btn{background:#32CD32;color:#1a1a1a;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;transition:all .2s;margin-bottom:20px}
        .refresh-btn:hover{background:#28b428;transform:translateY(-2px)}
        .tab-buttons{display:flex;gap:10px;margin-bottom:30px}
        .tab-btn{flex:1;padding:12px;border-radius:8px;border:1px solid #444;background:#2a2a2a;color:#f5f5f5;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
        .tab-btn.active{background:#f28500;color:#1a1a1a;border-color:#f28500}
        .tab-btn:hover:not(.active){border-color:#32CD32}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .form-group{margin-bottom:20px}
        .form-label{font-size:12px;font-weight:600;color:#e0e0e0;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
        .form-input{width:100%;padding:12px;border-radius:8px;border:1px solid #444;background:#1a1a1a;color:#f5f5f5;font-family:monospace;font-size:14px}
        .form-input:focus{outline:none;border-color:#32CD32;box-shadow:0 0 0 2px rgba(50,205,50,.3)}
        .status{padding:12px;border-radius:8px;border:1px solid #444;background:#2a2a2a;font-size:14px;margin-bottom:20px}
        .status.success{color:#32CD32;border-color:#32CD32}
        .status.error{color:#ff6b6b;border-color:#ff6b6b}
        .status.info{color:#66c2ff;border-color:#66c2ff}
        .tx-item{background:#333;border:1px solid #444;border-radius:8px;padding:16px;margin-bottom:12px;transition:all .2s;font-size:14px}
        .tx-item:hover{border-color:#32CD32;transform:translateX(4px)}
        .tx-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .tx-type{font-weight:600;padding:6px 12px;border-radius:6px;font-size:12px;text-transform:uppercase}
        .tx-type.received{background:#d4edda;color:#155724}
        .tx-type.sent{background:#f8d7da;color:#721c24}
        .tx-type.mined{background:#d1ecf1;color:#0c5460}
        .tx-amount{font-weight:700;color:#32CD32;font-size:16px}
        .tx-hash{color:#999;font-family:monospace;font-size:12px;line-height:1.6}
        .qr-container{background:#1a1a1a;border-radius:8px;border:1px solid #444;padding:24px;text-align:center}
        #qrcode{margin:0 auto}
        #indexerStatus{font-size:11px;color:#888;margin-bottom:20px;text-align:center;display:none;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <button class="hamburger-btn" onclick="alert('Menu not implemented')">‚ò∞</button>
                <button class="join-nostr-btn" onclick="alert('Join Nostr modal not implemented')">Join Nostr</button>
            </div>
            <div class="logo">‚ö° Nostrcoin Wallet</div>
            <div class="subtitle">NSTC Wallet ‚Ä¢ Nostr-native PoW</div>
        </div>

        <button class="refresh-btn" onclick="refreshWallet()" id="refreshBtn" style="display:none;">üîÑ Refresh Balance</button>

        <div id="status"></div>

        <div id="indexerStatus">Checking indexer...</div>

        <div id="notConnected">
            <div class="section">
                <div class="section-title">Connect Wallet</div>
                <p style="text-align:center;color:#aaa;margin-bottom:12px;">Connect your Nostr wallet to get started</p>
                <button class="button button-primary" onclick="connectExtension()">Connect Extension</button>
                <button class="button button-secondary" onclick="toggleNsecLogin()" style="margin-top:12px;">Login with nsec</button>
                <div id="nsecLoginForm" style="display:none;margin-top:20px;">
                    <div class="form-group">
                        <label class="form-label">Your nsec (private key)</label>
                        <input type="password" class="form-input" id="nsecInput" placeholder="nsec1...">
                        <p style="font-size:12px;color:#ff6b6b;margin-top:8px;">
                            Your nsec is used locally in this browser only.
                        </p>
                    </div>
                    <button class="button button-primary" onclick="loginWithNsec()">Login with nsec</button>
                    <button class="button button-secondary" onclick="toggleNsecLogin()">Cancel</button>
                </div>
            </div>
        </div>

        <div id="connected" style="display:none;">
            <div class="balance-card" style="background:#2a2a2a;border:1px solid #444;border-radius:12px;padding:32px;margin-bottom:30px;text-align:center;">
                <div style="font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Balance</div>
                <div class="balance-amount" id="balanceAmount">0.00000000</div>
                <div style="font-size:13px;color:#aaa;margin-bottom:12px;">Connected</div>
                <div class="npub-display" id="npubDisplay">npub...</div>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="send">üí∏ Send</button>
                <button class="tab-btn" data-tab="mine">‚õèÔ∏è Mine</button>
                <button class="tab-btn" data-tab="history">üìú History</button>
                <button class="tab-btn" data-tab="qr">üì± Receive</button>
            </div>

            <div id="send" class="tab-content active">
                <div class="section">
                    <div class="section-title">üí∏ Send NSTC</div>
                    <div class="form-group">
                        <label class="form-label">Recipient npub</label>
                        <input type="text" class="form-input" id="recipientNpub" placeholder="npub1...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount (NSTC)</label>
                        <input type="number" class="form-input" id="sendAmount" placeholder="0.00000000" step="0.00000001">
                    </div>
                    <button class="button button-primary" onclick="sendTransaction()">Send NSTC</button>
                </div>
            </div>

            <div id="mine" class="tab-content">
                <div class="section">
                    <div class="section-title">‚õèÔ∏è Mining</div>
                    <p style="text-align:center;color:#aaa;">Mining not implemented in this test version</p>
                </div>
            </div>

            <div id="history" class="tab-content">
                <div class="section">
                    <div class="section-title">üìú Transaction History</div>
                    <div id="historyList">Loading...</div>
                </div>
            </div>

            <div id="qr" class="tab-content">
                <div class="section">
                    <div class="section-title">üì± Receive NSTC</div>
                    <div class="qr-container">
                        <div id="qrcode"></div>
                        <p style="margin-top:16px;color:#aaa;">Your npub QR code</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const INDEXER_BASE = 'https://vm-182.lnvps.cloud';

        const CONFIG = {
            relays: [
                'wss://relay.damus.io',
                'wss://nos.lol',
                'wss://relay.nostr.band',
                'wss://nostr.mom'
            ]
        };

        const state = {
            pubkeyHex: null,
            npub: null,
            balance: 0,
            transactions: [],
            indexerStatus: {}
        };

        let usingNsecLogin = false;
        let originalNostr = null;

        function showStatus(message, type = 'info') {
            const div = document.getElementById('status');
            div.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => div.innerHTML = '', 8000);
        }

        // Tab switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

            if (tabId === 'qr' && state.npub) {
                const qr = document.getElementById('qrcode');
                qr.innerHTML = '';
                new QRCode(qr, {
                    text: state.npub,
                    width: 256,
                    height: 256,
                    colorDark: "#f5f5f5",
                    colorLight: "#1a1a1a"
                });
            }
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        // Extension connect
        async function connectExtension() {
            if (!window.nostr) {
                showStatus('No Nostr extension detected (e.g., Alby, nos2x)', 'error');
                return;
            }
            try {
                const pubkey = await window.nostr.getPublicKey();
                state.pubkeyHex = pubkey;
                await onWalletConnected('Extension');
            } catch (e) {
                showStatus('Extension rejected request', 'error');
            }
        }

        // Fetchers
        async function fetchBalance() {
            if (!state.pubkeyHex) return;
            try {
                const res = await fetch(`${INDEXER_BASE}/balance/${state.pubkeyHex}`);
                if (res.ok) {
                    const json = await res.json();
                    state.balance = json.balance || 0;
                    state.indexerStatus[INDEXER_BASE] = 'online';
                } else {
                    state.indexerStatus[INDEXER_BASE] = 'error';
                }
            } catch (e) {
                state.indexerStatus[INDEXER_BASE] = 'offline';
            }
            updateUI();
        }

        async function fetchHistory() {
            if (!state.pubkeyHex) return;
            try {
                const res = await fetch(`${INDEXER_BASE}/history/${state.pubkeyHex}`);
                if (res.ok) {
                    const json = await res.json();
                    state.transactions = json.history || [];
                    state.indexerStatus[INDEXER_BASE] = 'online';
                } else {
                    state.indexerStatus[INDEXER_BASE] = 'error';
                }
            } catch (e) {
                state.indexerStatus[INDEXER_BASE] = 'offline';
            }
            updateUI();
        }

        async function refreshWallet() {
            showStatus('Refreshing...', 'info');
            await Promise.all([fetchBalance(), fetchHistory()]);
        }

        async function onWalletConnected(source = 'nsec') {
            state.npub = pubkeyToNpub(state.pubkeyHex);
            document.getElementById('npubDisplay').textContent = state.npub;
            document.getElementById('notConnected').style.display = 'none';
            document.getElementById('connected').style.display = 'block';
            document.getElementById('refreshBtn').style.display = 'block';
            document.getElementById('indexerStatus').style.display = 'block';

            // Generate QR
            switchTab('send');
            const qr = document.getElementById('qrcode');
            qr.innerHTML = '';
            new QRCode(qr, {
                text: state.npub,
                width: 256,
                height: 256,
                colorDark: "#f5f5f5",
                colorLight: "#1a1a1a"
            });

            await refreshWallet();
            showStatus(`Connected via ${source}`, 'success');
        }

        // Send
        async function sendTransaction() {
            if (!window.nostr) {
                showStatus('No signer', 'error');
                return;
            }

            const recipientNpub = document.getElementById('recipientNpub').value.trim();
            const amountStr = document.getElementById('sendAmount').value.trim();
            if (!recipientNpub || !amountStr) return showStatus('Fill fields', 'error');

            const amount = parseFloat(amountStr);
            if (amount <= 0) return showStatus('Invalid amount', 'error');

            const recipientHex = npubToHex(recipientNpub);
            if (!recipientHex) return showStatus('Invalid recipient npub', 'error');
            if (recipientHex === state.pubkeyHex) return showStatus('Cannot send to self', 'error');

            try {
                const event = {
                    kind: 30334,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [['p', recipientHex], ['amount', amount.toFixed(8)]],
                    content: `Sending ${amount.toFixed(8)} NSTC`
                };

                const signed = await window.nostr.signEvent(event);

                const pubs = CONFIG.relays.map(r => new Promise(resolve => {
                    const ws = new WebSocket(r);
                    ws.onopen = () => ws.send(JSON.stringify(['EVENT', signed]));
                    ws.onmessage = m => m.data.includes('"OK"') && resolve(true);
                    ws.onerror = () => resolve(false);
                    setTimeout(() => resolve(false), 8000);
                }));

                const results = await Promise.all(pubs);
                const ok = results.some(r => r);

                if (ok) {
                    const shortId = signed.id.substring(0, 12);
                    showStatus(`‚úì Sent ${amount.toFixed(8)} NSTC! Event: ${shortId}...`, 'success');
                    setTimeout(refreshWallet, 8000);
                } else {
                    showStatus('Failed to publish to relays', 'error');
                }
            } catch (e) {
                showStatus('Send error: ' + e.message, 'error');
            }
        }

        // UI updates
        function updateUI() {
            document.getElementById('balanceAmount').textContent = state.balance.toFixed(8);
            updateHistoryDisplay();
            updateIndexerStatusDisplay();
        }

        function updateHistoryDisplay() {
            const container = document.getElementById('historyList');
            if (!state.transactions || state.transactions.length === 0) {
                container.innerHTML = '<p style="color:#888;text-align:center;">No transactions yet</p>';
                return;
            }

            container.innerHTML = '';
            state.transactions.forEach(tx => {
                if (!tx || !tx.id) return; // safety
                const div = document.createElement('div');
                div.className = 'tx-item';
                const sign = tx.type === 'sent' ? '-' : '+';
                div.innerHTML = `
                    <div class="tx-header">
                        <span class="tx-type ${tx.type}">${tx.type.toUpperCase()}</span>
                        <span class="tx-amount">${sign}${tx.amount.toFixed(8)} NSTC</span>
                    </div>
                    <div class="tx-hash">ID: ${tx.id.substring(0, 16)}...</div>
                `;
                container.appendChild(div);
            });
        }

        function updateIndexerStatusDisplay() {
            const div = document.getElementById('indexerStatus');
            const statuses = Object.entries(state.indexerStatus).map(([url, s]) => {
                const icon = s === 'online' ? '‚úì' : '‚úó';
                const color = s === 'online' ? '#32CD32' : '#ff6b6b';
                return `<span style="color:${color}">${icon} indexer</span>`;
            });
            div.innerHTML = statuses.length ? `Indexer: ${statuses.join(' ')}` : 'Checking indexer...';
        }

        // nsec login
        function toggleNsecLogin() {
            const form = document.getElementById('nsecLoginForm');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
            document.getElementById('nsecInput').value = '';
        }

        function createNsecSigner(priv) {
            const pub = NostrTools.getPublicKey(priv);
            return {
                getPublicKey: async () => pub,
                signEvent: async (e) => NostrTools.finalizeEvent({ ...e, pubkey: pub }, priv)
            };
        }

        async function loginWithNsec() {
            try {
                const nsec = document.getElementById('nsecInput').value.trim();
                if (!nsec.startsWith('nsec1')) throw new Error('Invalid nsec');

                const { type, data } = NostrTools.nip19.decode(nsec);
                if (type !== 'nsec') throw new Error('Not nsec');

                const privHex = typeof data === 'string' ? data : Array.from(data).map(b => b.toString(16).padStart(2,'0')).join('');
                state.pubkeyHex = NostrTools.getPublicKey(privHex);

                if (window.nostr) originalNostr = window.nostr;
                window.nostr = createNsecSigner(privHex);
                usingNsecLogin = true;

                await onWalletConnected('nsec');
                toggleNsecLogin();
            } catch (e) {
                showStatus('nsec error: ' + e.message, 'error');
            }
        }

        // Bech32 helpers
        const CHARSET = "qpzry9x8gf2tvdw0s3jn54khce6mua7l";
        function hexToBytes(h) { const b=[]; for(let i=0;i<h.length;i+=2) b.push(parseInt(h.substr(i,2),16)); return b; }
        function convertBits(d,f,t,p=true){let a=0,b=0,r=[],m=(1<<t)-1; for(let v of d){a=(a<<f|v)&((1<<(f+t-1))-1);b+=f;while(b>=t){b-=t;r.push((a>>b)&m)}} if(p&&b)r.push((a<<(t-b))&m);return r;}
        function bech32Encode(h,d){const c=createChecksum(h,d);return h+'1'+d.concat(c).map(v=>CHARSET[v]).join('');}
        function createChecksum(h,d){const v=hrpExpand(h).concat(d).concat([0,0,0,0,0,0]);let p=polymod(v)^1;const c=[];for(let i=0;i<6;i++)c.push((p>>5*(5-i))&31);return c;}
        function polymod(v){const G=[0x3b6a57b2,0x26508e6d,0x1ea119fa,0x3d4233dd,0x2a1462b3];let c=1;for(let x of v){let t=c>>25;c=(c&0x1ffffff)<<5^x;for(let i=0;i<5;i++)if((t>>i)&1)c^=G[i]}return c;}
        function hrpExpand(h){return [...h].flatMap(c=>[(c.charCodeAt(0)>>5),(c.charCodeAt(0)&31)]).concat(0);}
        function pubkeyToNpub(h){return bech32Encode('npub',convertBits(hexToBytes(h),8,5));}
        function npubToHex(n){try{const {data}=NostrTools.nip19.decode(n);return typeof data==='string'?data:Array.from(data).map(b=>b.toString(16).padStart(2,'0')).join('');}catch(e){return null;}}
    </script>
</body>
</html>