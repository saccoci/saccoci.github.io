<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Nostrcoin Wallet v0.1.1 - Fixed nsec send/history/balance auto-update -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostrcoin (NSTC) Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.3/qrcode.min.js"></script>
    <script src="https://unpkg.com/nostr-tools@2.7.0/lib/nostr.bundle.js"></script>
    <style>
        /* Your original styles unchanged */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a1a;color:#f5f5f5;min-height:100vh;padding:20px}
        /* ... (all your styles here, omitted for brevity but kept identical) ... */
    </style>
</head>
<body>
    <!-- Your original HTML body unchanged -->
    <!-- ... (full body from your attached file) ... -->

    <script>
        // === NEW: Public Indexer ===
        const INDEXER_BASE = 'https://vm-182.lnvps.cloud';

        const CONFIG = {
            protocolTag: 'nostrcoin',
            relays: [
                'wss://relay.damus.io',
                'wss://nos.lol',
                'wss://relay.nostr.band',
                'wss://nostr.mom'
            ]
        };

        const state = {
            pubkeyHex: null,
            npub: null,
            balance: 0,
            transactions: [],
            mining: false
        };

        let nsecPrivKeyHex = null;
        let usingNsecLogin = false;
        let originalNostr = null;

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 8000);
        }

        // === Updated fetch functions using public indexer ===
        async function fetchBalance() {
            if (!state.pubkeyHex) return;
            try {
                const res = await fetch(`${INDEXER_BASE}/balance/${state.pubkeyHex}`);
                if (res.ok) {
                    const data = await res.json();
                    state.balance = data.balance || 0;
                }
            } catch (e) {
                console.warn('Balance fetch error:', e);
            }
            updateBalanceDisplay();
        }

        async function fetchHistory() {
            if (!state.pubkeyHex) return;
            try {
                const res = await fetch(`${INDEXER_BASE}/history/${state.pubkeyHex}`);
                if (res.ok) {
                    const data = await res.json();
                    state.transactions = data.history || [];
                }
            } catch (e) {
                console.warn('History fetch error:', e);
            }
            updateHistoryDisplay();
        }

        async function refreshWallet() {
            await Promise.all([fetchBalance(), fetchHistory()]);
        }

        // === Updated onWalletConnected ===
        async function onWalletConnected() {
            state.npub = pubkeyToNpub(state.pubkeyHex);
            document.getElementById('npubDisplay').textContent = state.npub;

            document.getElementById('notConnected').style.display = 'none';
            document.getElementById('connected').style.display = 'block';
            document.getElementById('refreshBtn').style.display = 'block';

            // Auto load balance/history on connect
            await refreshWallet();
        }

        // === Updated sendTransaction with success message + auto refresh ===
        async function sendTransaction() {
            // ... (your original validation code) ...

            try {
                // ... (event creation) ...

                const signedEvent = await window.nostr.signEvent(event);

                // Publish (your original publish code)
                // ...

                if (success) {
                    const shortId = signedEvent.id.substring(0, 12);
                    showStatus(`âœ“ Sent ${amount.toFixed(8)} NSTC! Event: ${shortId}...`, 'success');
                    setTimeout(refreshWallet, 8000); // Auto refresh after 8s
                } else {
                    showStatus('Publish failed', 'error');
                }
            } catch (e) {
                showStatus('Send failed: ' + e.message, 'error');
            }
        }

        // === Add simple display updates (if not already present) ===
        function updateBalanceDisplay() {
            document.getElementById('balanceAmount').textContent = state.balance.toFixed(8);
        }

        function updateHistoryDisplay() {
            // Your original history rendering code, with safe tx.id check
            state.transactions.forEach(tx => {
                if (tx && tx.id) {
                    // render tx.id.substring(0,16)...
                }
            });
        }

        // === Extension connect function (was missing in some versions) ===
        async function connectWallet() {
            if (!window.nostr) {
                showStatus('No extension found', 'error');
                return;
            }
            try {
                const pubkey = await window.nostr.getPublicKey();
                state.pubkeyHex = pubkey;
                await onWalletConnected();
            } catch (e) {
                showStatus('Extension denied', 'error');
            }
        }

        // === Your original nsec signer, loginWithNsec, disconnectWallet, bech32 functions unchanged ===
        // (keep all your original code here)

    </script>
</body>
</html>
