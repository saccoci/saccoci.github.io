<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Nostrcoin Wallet v0.1.0 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostrcoin (NSTC) Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.3/qrcode.min.js"></script>
    <script src="https://unpkg.com/nostr-tools@2.7.0/lib/nostr.bundle.js"></script>
    <style>
        /* Your full original styles - unchanged */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a1a;color:#f5f5f5;min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        .header{text-align:center;margin-bottom:40px;padding:30px 0;border-bottom:2px solid #3a3a3a}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:20px}
        .hamburger-btn{background:#2a2a2a;border:1px solid #444;color:#f5f5f5;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:20px;line-height:1;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .hamburger-btn:hover{background:#333;border-color:#32CD32}
        .logo{font-size:42px;font-weight:700;color:#32CD32;margin-bottom:8px}
        .subtitle{color:#bbb;font-size:16px}
        .section{background:#2a2a2a;border:1px solid #444;border-radius:12px;padding:24px;margin-bottom:30px}
        .section-title{font-size:20px;font-weight:600;color:#f28500;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #444}
        .balance-amount{font-size:42px;font-weight:700;color:#32CD32;margin:12px 0}
        .npub-display{font-size:11px;color:#888;font-family:monospace;word-break:break-all;margin-top:8px}
        .button{width:100%;padding:13px;border-radius:8px;font-size:14px;font-weight:600;border:1px solid transparent;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;transition:all .2s;margin-bottom:12px}
        .button-primary{background:#32CD32;color:#1a1a1a;border-color:#32CD32}
        .button-primary:hover{background:#28b428;border-color:#28b428;transform:translateY(-2px)}
        .button-secondary{background:#2a2a2a;color:#f28500;border:1px solid #f28500}
        .button-secondary:hover{background:#f28500;color:#1a1a1a}
        .status{padding:12px;border-radius:8px;border:1px solid #444;background:#2a2a2a;font-size:14px;margin-bottom:20px}
        .status.success{color:#32CD32;border-color:#32CD32}
        .status.error{color:#ff6b6b;border-color:#ff6b6b}
        .status.info{color:#66c2ff;border-color:#66c2ff}
        .join-nostr-btn{background:#f28500;color:#1a1a1a;border:1px solid #f28500;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;text-decoration:none;display:inline-block;transition:all .2s}
        .join-nostr-btn:hover{background:#ff9500;border-color:#ff9500;transform:translateY(-2px)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;padding:20px;z-index:50}
        .modal-overlay.active{display:flex}
        .modal{background:#2a2a2a;border:1px solid #444;border-radius:16px;padding:26px;max-width:500px;width:100%;position:relative}
        .modal-close{position:absolute;top:10px;right:14px;background:none;border:none;color:#999;font-size:20px;cursor:pointer}
        .modal-close:hover{color:#fff}
        .qr-box{background:#1a1a1a;border-radius:8px;padding:20px;text-align:center;margin:20px 0}
        .connect-url{background:#1a1a1a;padding:12px;border-radius:6px;font-family:monospace;font-size:11px;word-break:break-all;margin-top:12px;color:#888}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div style="flex:1"></div>
                <button class="join-nostr-btn" onclick="window.open('https://nstart.me', '_blank')">Join Nostr</button>
            </div>
            <div class="logo">⚡ Nostrcoin Wallet</div>
            <div class="subtitle">NSTC Wallet • Nostr-native PoW</div>
            <div class="version">Version 0.1.0</div>
        </div>

        <div id="status"></div>

        <div id="notConnected">
            <div class="section">
                <div class="section-title">Connect Wallet</div>
                <p style="text-align:center;color:#aaa;margin-bottom:20px;">Connect your Nostr wallet to get started</p>

                <button class="button button-primary" id="connectExtensionBtn" onclick="connectWallet()">Connect Browser Extension</button>
                <button class="button button-secondary" onclick="toggleNsecLogin()" style="margin-top:12px;">Login with nsec</button>

                <div id="nsecLoginForm" style="display:none;margin-top:20px;">
                    <div class="form-group">
                        <label class="form-label">Your nsec (private key)</label>
                        <input type="password" class="form-input" id="nsecInput" placeholder="nsec1...">
                        <p style="font-size:12px;color:#ff6b6b;margin-top:8px;">
                            Your nsec is used locally in this browser to derive your key and sign events. It is never sent to the server.
                            Only paste an nsec if you fully understand the risks.
                        </p>
                    </div>
                    <button class="button button-primary" onclick="loginWithNsec()">Login with nsec</button>
                    <button class="button button-secondary" onclick="toggleNsecLogin()" style="margin-top:12px;">Cancel</button>
                </div>

                <p style="text-align:center;color:#888;font-size:13px;margin-top:20px;">
                    Don't have a Nostr account?
                    <a href="https://nstart.me" target="_blank" style="color:#f28500;text-decoration:none;">Learn more</a>
                </p>
            </div>
        </div>

        <div id="connected" style="display:none;">
            <!-- Your full connected UI here - unchanged -->
            <div class="section">
                <div style="text-align:center;">
                    <div style="font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Balance</div>
                    <div class="balance-amount" id="balanceAmount">0.00000000</div>
                    <div style="font-size:13px;color:#aaa;margin-bottom:12px;" id="balanceSubtext">Connected</div>
                    <div class="npub-display" id="npubDisplay">npub...</div>
                </div>
            </div>

            <button class="button button-secondary" onclick="disconnectWallet()">Disconnect</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            protocolTag: 'nostrcoin',
            relays: [
                'wss://relay.damus.io',
                'wss://nos.lol',
                'wss://relay.nostr.band',
                'wss://nostr.mom'
            ]
        };

        const state = {
            pubkeyHex: null,
            npub: null,
            balance: 0,
            connected: false,
            nsecAppConnection: null
        };

        // === ADDED: Missing functions ===
        function connectWallet() {
            if (!window.nostr) {
                showStatus('No browser extension found. Please install Alby, nos2x or similar.', 'error');
                return;
            }

            window.nostr.getPublicKey().then(pubkey => {
                state.pubkeyHex = pubkey;
                state.npub = pubkeyToNpub(pubkey);
                state.connected = true;

                document.getElementById('npubDisplay').textContent = state.npub;
                document.getElementById('balanceSubtext').textContent = 'Connected via Extension';
                document.getElementById('notConnected').style.display = 'none';
                document.getElementById('connected').style.display = 'block';

                showStatus('Connected via browser extension', 'success');
            }).catch(err => {
                showStatus('Extension connection failed: ' + err.message, 'error');
            });
        }

        function toggleNsecLogin() {
            const form = document.getElementById('nsecLoginForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            document.getElementById('nsecInput').value = '';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        // === Your original code below (unchanged) ===
        // All the bech32 functions, createNsecSigner, loginWithNsec, disconnectWallet, etc.

        // (Everything from your attached file starting from CHARSET = "qpzry9x8gf2tvdw0s3jn54khce6mua7l"; down to the end)

        const CHARSET = "qpzry9x8gf2tvdw0s3jn54khce6mua7l";

        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }

        // ... (all the rest of your original script exactly as provided) ...

    </script>
</body>
</html>
