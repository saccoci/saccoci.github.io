<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Nostrcoin Wallet v0.1.0-test -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostrcoin (NSTC) Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.5.3/qrcode.min.js"></script>
    <script src="https://cdn.nostrpass.com/embassy.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a1a;color:#f5f5f5;min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto}
        .header{text-align:center;margin-bottom:40px;padding:30px 0;border-bottom:2px solid #3a3a3a}
        .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:20px}
        .logo{font-size:42px;font-weight:700;color:#32CD32;margin-bottom:8px}
        .subtitle{color:#bbb;font-size:16px}
        .button{width:100%;padding:13px;border-radius:8px;font-size:14px;font-weight:600;border:1px solid transparent;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;transition:all .2s;margin-bottom:12px}
        .button-primary{background:#32CD32;color:#1a1a1a;border-color:#32CD32}
        .button-primary:hover{background:#28b428;border-color:#28b428;transform:translateY(-2px)}
        .button-secondary{background:#2a2a2a;color:#f28500;border:1px solid #f28500}
        .button-secondary:hover{background:#f28500;color:#1a1a1a}
        .section{background:#2a2a2a;border:1px solid #444;border-radius:12px;padding:24px;margin-bottom:30px}
        .section-title{font-size:20px;font-weight:600;color:#f28500;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #444}
        .balance-amount{font-size:42px;font-weight:700;color:#32CD32;margin:12px 0}
        .npub-display{font-size:11px;color:#888;font-family:monospace;word-break:break-all;margin-top:8px}
        .status{padding:12px;border-radius:8px;border:1px solid #444;background:#2a2a2a;font-size:14px;margin-bottom:20px}
        .status.success{color:#32CD32;border-color:#32CD32}
        .status.error{color:#ff6b6b;border-color:#ff6b6b}
        .status.info{color:#66c2ff;border-color:#66c2ff}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">⚡ Nostrcoin Wallet</div>
            <div class="subtitle">NSTC Wallet • Nostr-native PoW</div>
        </div>

        <div id="status"></div>

        <div id="notConnected">
            <div class="section">
                <div class="section-title">Connect Wallet</div>
                <p style="text-align:center;color:#aaa;margin-bottom:20px;">Connect your Nostr wallet to get started</p>
                
                <!-- Desktop: Extension -->
                <button class="button button-primary" id="extensionBtn">Connect Extension</button>
                
                <!-- Mobile: NostrPass -->
                <button class="button button-primary" id="nostrpassBtn" style="margin-top:12px;">Connect Mobile (NostrPass)</button>
            </div>
        </div>

        <div id="connected" style="display:none;">
            <div class="section">
                <div style="text-align:center;">
                    <div style="font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Balance</div>
                    <div class="balance-amount" id="balanceAmount">0.00000000</div>
                    <div style="font-size:13px;color:#aaa;margin-bottom:12px;" id="balanceSubtext">Connected</div>
                    <div class="npub-display" id="npubDisplay">npub...</div>
                </div>
            </div>
            
            <button class="button button-secondary" id="disconnectBtn">Disconnect</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            protocolTag: 'nostrcoin',
            difficulty: 4,
            eventKinds: {
                mining: 30333,
                transfer: 30334
            }
        };

        const state = {
            pubkeyHex: null,
            npub: null,
            balance: 0,
            connected: false
        };

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        function pubkeyToNpub(hexPubkey) {
            // Proper bech32 conversion
            const bytes = hexToBytes(hexPubkey);
            const converted = convertBits(bytes, 8, 5);
            if (!converted) throw new Error('Failed to encode npub');
            return bech32Encode('npub', converted);
        }

        const CHARSET = "qpzry9x8gf2tvdw0s3jn54khce6mua7l";

        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return bytes;
        }

        function convertBits(data, fromBits, toBits, pad = true) {
            let acc = 0;
            let bits = 0;
            const result = [];
            const maxv = (1 << toBits) - 1;
            const max_acc = (1 << (fromBits + toBits - 1)) - 1;
            for (let value of data) {
                if (value < 0 || (value >> fromBits)) return null;
                acc = ((acc << fromBits) | value) & max_acc;
                bits += fromBits;
                while (bits >= toBits) {
                    bits -= toBits;
                    result.push((acc >> bits) & maxv);
                }
            }
            if (pad) {
                if (bits) result.push((acc << (toBits - bits)) & maxv);
            } else if (bits >= fromBits || ((acc << (toBits - bits)) & maxv)) {
                return null;
            }
            return result;
        }

        function bech32Encode(hrp, data) {
            const checksum = createChecksum(hrp, data);
            const values = data.concat(checksum);
            return hrp + '1' + values.map(v => CHARSET[v]).join('');
        }

        function createChecksum(hrp, data) {
            const values = hrpExpand(hrp).concat(data);
            const polymodResult = polymod(values.concat([0, 0, 0, 0, 0, 0])) ^ 1;
            const checksum = [];
            for (let p = 0; p < 6; ++p) {
                checksum.push((polymodResult >> 5 * (5 - p)) & 31);
            }
            return checksum;
        }

        function polymod(values) {
            const GENERATORS = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
            let chk = 1;
            for (let p = 0; p < values.length; ++p) {
                const top = chk >> 25;
                chk = (chk & 0x1ffffff) << 5 ^ values[p];
                for (let i = 0; i < 5; i++) {
                    if ((top >> i) & 1) {
                        chk ^= GENERATORS[i];
                    }
                }
            }
            return chk;
        }

        function hrpExpand(hrp) {
            const ret = [];
            for (let i = 0; i < hrp.length; i++) ret.push(hrp.charCodeAt(i) >> 5);
            ret.push(0);
            for (let i = 0; i < hrp.length; i++) ret.push(hrp.charCodeAt(i) & 31);
            return ret;
        }

        async function handleConnection(pubkeyHex, source) {
            state.pubkeyHex = pubkeyHex;
            state.npub = pubkeyToNpub(pubkeyHex);
            state.connected = true;

            document.getElementById('npubDisplay').textContent = state.npub;
            document.getElementById('balanceSubtext').textContent = `Connected via ${source}`;
            document.getElementById('notConnected').style.display = 'none';
            document.getElementById('connected').style.display = 'block';

            showStatus(`✓ Connected successfully`, 'success');
        }

        // Extension connection
        document.getElementById('extensionBtn').addEventListener('click', async () => {
            // Check for native extension (not NostrPass)
            if (!window.nostr || window.nostr._isNostrPass) {
                showStatus('No Nostr extension found. Install nos2x, Alby, or similar.', 'error');
                return;
            }

            try {
                showStatus('Connecting to extension...', 'info');
                const pubkey = await window.nostr.getPublicKey();
                await handleConnection(pubkey, 'Extension');
            } catch (error) {
                showStatus('Extension connection failed: ' + error.message, 'error');
            }
        });

        // NostrPass connection - mark it so we can differentiate
        document.getElementById('nostrpassBtn').addEventListener('click', async () => {
            try {
                showStatus('Initializing NostrPass...', 'info');
                
                // Clear any existing window.nostr from extensions
                const hasExtension = window.nostr && !window.nostr._isNostrPass;
                
                if (hasExtension) {
                    showStatus('Please disable browser extensions and use NostrPass on mobile', 'error');
                    return;
                }
                
                // Wait for NostrPass to initialize
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (!window.nostr) {
                    showStatus('NostrPass not available. This works best on mobile with a Nostr signer app.', 'error');
                    return;
                }

                showStatus('Requesting public key from NostrPass...', 'info');
                const pubkey = await window.nostr.getPublicKey();
                
                // Mark as NostrPass connection
                window.nostr._isNostrPass = true;
                
                await handleConnection(pubkey, 'NostrPass');
            } catch (error) {
                console.error('NostrPass error:', error);
                showStatus('NostrPass connection failed: ' + error.message, 'error');
            }
        });

        // Disconnect
        document.getElementById('disconnectBtn').addEventListener('click', () => {
            state.pubkeyHex = null;
            state.npub = null;
            state.connected = false;

            document.getElementById('connected').style.display = 'none';
            document.getElementById('notConnected').style.display = 'block';
            showStatus('Wallet disconnected', 'info');
        });

        // Initialize NostrPass on load
        window.addEventListener('load', () => {
            console.log('Page loaded, NostrPass should be available');
            console.log('window.nostr available:', !!window.nostr);
        });
    </script>
</body>
</html>